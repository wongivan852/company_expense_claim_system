{% extends 'base.html' %}
{% load static %}

{% block title %}Select Claims for Printing - CG Global Entertainment{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5">
            <i class="fas fa-print text-primary"></i>
            {{ page_title }}
        </h1>
        <a href="{% url 'claims:claim_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Claims
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="post" id="printForm">
                {% csrf_token %}
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                            <label class="form-check-label" for="selectAll">
                                <strong>Select All Claims</strong>
                            </label>
                        </div>
                    </div>
                </div>

                {% if claims %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="50px">
                                    <input type="checkbox" id="headerCheckbox" class="form-check-input">
                                </th>
                                <th>Claim Number</th>
                                <th>Event/Description</th>
                                <th>Company</th>
                                <th>Period</th>
                                <th>Total (HKD)</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in claims %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="selected_claims" value="{{ claim.id }}" class="form-check-input claim-checkbox">
                                </td>
                                <td>
                                    <strong class="text-primary">{{ claim.claim_number }}</strong>
                                </td>
                                <td>
                                    <strong>{{ claim.event_name|truncatechars:40 }}</strong>
                                    {% if claim.expense_items.count %}
                                    <br><small class="text-muted">{{ claim.expense_items.count }} items</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ claim.company.code }}</span>
                                </td>
                                <td>
                                    <small>
                                        {{ claim.period_from|date:"M d" }} - 
                                        {{ claim.period_to|date:"M d, Y" }}
                                    </small>
                                </td>
                                <td>
                                    <strong class="text-success">
                                        HKD {{ claim.total_amount_hkd|floatformat:2|default:"0.00" }}
                                    </strong>
                                </td>
                                <td>
                                    {% if claim.status == 'approved' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> Approved
                                        </span>
                                    {% elif claim.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                    {% elif claim.status == 'rejected' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times-circle"></i> Rejected
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-edit"></i> Draft
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ claim.created_at|date:"M d, Y" }}<br>
                                        {{ claim.created_at|time:"H:i" }}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary btn-lg" disabled id="printButton">
                                <i class="fas fa-print"></i> Print Selected Claims
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No claims available for printing.
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const headerCheckbox = document.getElementById('headerCheckbox');
    const claimCheckboxes = document.querySelectorAll('.claim-checkbox');
    const printButton = document.getElementById('printButton');
    
    function updatePrintButton() {
        const checkedBoxes = document.querySelectorAll('.claim-checkbox:checked');
        printButton.disabled = checkedBoxes.length === 0;
    }
    
    function updateSelectAllState() {
        const checkedBoxes = document.querySelectorAll('.claim-checkbox:checked');
        const allBoxes = document.querySelectorAll('.claim-checkbox');
        
        if (checkedBoxes.length === allBoxes.length) {
            selectAllCheckbox.checked = true;
            headerCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
            headerCheckbox.indeterminate = false;
        } else if (checkedBoxes.length > 0) {
            selectAllCheckbox.checked = false;
            headerCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
            headerCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            headerCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            headerCheckbox.indeterminate = false;
        }
    }
    
    selectAllCheckbox.addEventListener('change', function() {
        claimCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        headerCheckbox.checked = this.checked;
        updatePrintButton();
    });
    
    headerCheckbox.addEventListener('change', function() {
        claimCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        selectAllCheckbox.checked = this.checked;
        updatePrintButton();
    });
    
    claimCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllState();
            updatePrintButton();
        });
    });
    
    // Initial state
    updatePrintButton();
    updateSelectAllState();
});
</script>
{% endblock %}
